<%- include('./partials/header') %>
<%- include('./partials/navigation') %>
<div class="container">
    <%- include('./partials/message') %>
</div>
<div class="container">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <div class="card shadow-box">
                <div class="card-header">
                    <h4>Edit article</h4>
                </div>
                <div>
                    <textarea id="editor" name="content" required></textarea>
                    <script>
                      const defaultValue = "# \n**Tags:** \n**Description:** \n\n";

                      const simplemde = new SimpleMDE({
                        autofocus: true,
                        element: document.getElementById("editor"),
                        spellChecker: false,
                        autoDownloadFontAwesome: false,
                        initialValue: defaultValue,
                        toolbar: [
                          {
                            name: "bold",
                            action: SimpleMDE.toggleBold,
                            className: "fa fa-bold",
                            title: "Bold"
                          },
                          {
                            name: "italic",
                            action: SimpleMDE.toggleItalic,
                            className: "fa fa-italic",
                            title: "Italic"
                          },
                          {
                            name: "heading",
                            action: SimpleMDE.toggleHeadingSmaller,
                            className: "fa fa-header",
                            title: "Heading"
                          },
                          "|",
                          {
                            name: "quote",
                            action: SimpleMDE.toggleBlockquote,
                            className: "fa fa-quote-left",
                            title: "Quote"
                          },
                          {
                            name: "unordered-list",
                            action: SimpleMDE.toggleUnorderedList,
                            className: "fa fa-list-ul",
                            title: "Generic List"
                          },
                          {
                            name: "ordered-list",
                            action: SimpleMDE.toggleOrderedList,
                            className: "fa fa-list-ol",
                            title: "Numbered List"
                          },
                          "|",
                          {
                            name: "link",
                            action: SimpleMDE.drawLink,
                            className: "fa fa-link",
                            title: "Create Link"
                          },
                          {
                            name: "image",
                            action: () => {
                              importImage();
                            },
                            className: "fa fa-picture-o",
                            title: "Insert Image"
                          },
                          {
                            name: "table",
                            action: SimpleMDE.drawTable,
                            className: "fa fa-table",
                            title: "Insert Table"
                          },
                          "|",
                          {
                            name: "preview",
                            action: SimpleMDE.togglePreview,
                            className: "fa fa-eye no-disable",
                            title: "Toggle Preview"
                          },
                          {
                            name: "side-by-side",
                            action: SimpleMDE.toggleSideBySide,
                            className: "fa fa-columns no-disable no-mobile",
                            title: "Toggle Side by Side"
                          },
                          {
                            name: "fullscreen",
                            action: SimpleMDE.toggleFullScreen,
                            className: "fa fa-arrows-alt no-disable no-mobile",
                            title: "Toggle Fullscreen"
                          },
                          "|",
                          {
                            name: "reset",
                            action: () => {
                              clearInput()
                            },
                            className: "fa fa-trash",
                            title: "Clear your input"
                          },
                          {
                            name: "import",
                            action: () => {
                              importArticle()
                            },
                            className: "fa fa-file",
                            title: "Import from file"
                          },
                          {
                            name: "submit",
                            action: () => {
                              submitArticle()
                            },
                            className: "fa fa-send-o",
                            title: "Submit your article"
                          }
                        ]
                      });
                    </script>
                </div>
            </div>
        </div>
    </div>
</div>
<input type="file" id="upload" accept=".md" style="visibility: hidden;"/>
<input type="file" id="uploadImage" name="file" accept="image/*" style="visibility: hidden;"/>
<script>
  const uploadImage = $('#uploadImage');

  function importImage() {
    uploadImage.click();
  }

  function insertText(text) {
    let pos = simplemde.codemirror.getCursor();
    simplemde.codemirror.setSelection(pos, pos);
    simplemde.codemirror.replaceSelection(text);
  }

  uploadImage.change(() => {
    let imageForm = new FormData();
    imageForm.append('smfile', $('#uploadImage')[0].files[0]);
    $.ajax({
      url: 'https://sm.ms/api/upload',
      type: 'POST',
      data: imageForm,
      mimeType: 'multipart/form-data',
      contentType: false,
      cache: false,
      processData: false,
      dataType: 'json',
      success: function (data) {
        if (data.success) {
          const imageUrl = data.data.url;
          insertText(`![image](${imageUrl})`);
          document.getElementById("uploadImage").value = "";
        }
      },
      error: function (reason) {
        alert(reason.responseText)
      }
    });
  })

  //const defaultValue = "# \n**Tags:** \n**Description:** \n";
  let postPath = "/api/post";
  <% if(article !== undefined){ %>
  $(document).ready(function () {
    $.get("/api/article/<%- article.link %>", function (data) {
      simplemde.value(data.content);
    });
  });
  postPath = "/api/edit/<%- article.link %>";
  <% } %>
  function submitArticle() {
    let firstLine = simplemde.value().split('\n')[0];
    let secondLine = simplemde.value().split('\n')[1];
    let thirdLine = simplemde.value().split('\n')[2];
    let title = firstLine.replace(/#*/, "").trim();
    let tags = secondLine.replace(/\*\*.*\*\*/, "").trim();
    let description = thirdLine.replace(/\*\*.*\*\*/, "").trim();
    const canSubmit = (simplemde.value() !== "")
        && (firstLine.startsWith("#"))
        && (secondLine.startsWith("**")
            && (thirdLine.startsWith("**"))
            && (title !== ""));
    if (canSubmit) {
      $.post(postPath, {
        title: title,
        tag: tags,
        description: description,
        content: simplemde.value()
      }, (data) => {
        simplemde.value(defaultValue);
      });
    } else {
      alert(`The format of the beginning of the article is as follows: \n# You must have a title here.\n**tags:** Tag Tag Tag\n**description:** Description of the article`);
    }
  }

  function importArticle() {
    $('#upload').click();
  }

  function clearInput() {
    if (confirm("Are you sure to clear you input?")) {
      simplemde.value(defaultValue);
    }
  }

  document.getElementById("upload").onchange = function () {
    let fileInput = document.getElementById('upload');
    if (fileInput.files && fileInput.files.length > 0 && fileInput.files[0].size > 0) {
      let file = fileInput.files[0];
      let reader = new FileReader();
      reader.onloadend = function (event) {
        if (event.target.readyState === FileReader.DONE) {
          simplemde.value(event.target.result);
        }
      };
      reader.readAsText(file, 'utf-8');
    }
  }
</script>

<%- include('./partials/end') %>
